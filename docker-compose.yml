services:
  web:
    container_name: webserv01
    build:
      context: .
    ports:
      - "80:8080"
    restart: unless-stopped

    # PROD DEFAULT:
    # Root filesystem is read-only for maximum security.
    # Switch to `read_only: false` only if you want to relax this in dev.
    read_only: true

    user: "33:33"

    pids_limit: 200
    ulimits:
      nofile:
        soft: 4096
        hard: 8192

    volumes:
      # Code directory:
      # ⚠️ Default is read-only for security.
      # Set `read_only: false` during development if you need to edit code inside the container.
      - type: bind
        source: ./www
        target: /var/www/html
        read_only: true

      # Uploads (explicit bind, read-write)
     # - type: bind
     #   source: ./uploads
     #   target: /var/www/html/uploads
     #   # read_only: false  # (default)
        
      # data (explicit bind, read-write)
      - type: bind
        source: ./data
        target: /var/www/html/data
        # read_only: false  # (default)

     # bake in conf
      - type: bind
        source: ./conf/apache-conf
        target: /opt/apache-extra
        read_only: true

    tmpfs:
      - /tmp:mode=1777
      - /var/run/apache2:mode=0755,uid=33,gid=33
      - /var/lock/apache2:mode=0755,uid=33,gid=33
      - /var/log/apache2:mode=0755,uid=33,gid=33
      - /var/www/html/cache:mode=0755,uid=33,gid=33

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    environment:
      APACHE_SERVER_NAME: "localhost"
      TZ: "Europe/Copenhagen"
      PHP_MEMORY_LIMIT: 256M
      PHP_UPLOAD_MAX_FILESIZE: 2000M
      PHP_MAX_FILE_UPLOADS: "1000"
      PHP_MAX_INPUT_VARS: "50000"
      PHP_MAX_MULTIPART_BODY_PARTS: "5000"   # only used by PHP ≥ 8.4
      PHP_POST_MAX_SIZE: 2000M
      PHP_MAX_EXECUTION_TIME: 120
      OPCACHE_ENABLE: "0"
      PHP_TZ: "Europe/Copenhagen"
      # TRUSTED_PROXIES: "172.20.0.5"
      # HSTS: "max-age=31536000; includeSubDomains"
      # CSP_REPORT_ONLY: "default-src 'self'; img-src 'self' data:; object-src 'none'"
      # CSP: "default-src 'self'; img-src 'self' data:; object-src 'none'"
      # APP_WRITABLE_DIRS: not needed — uploads/cache are mounted with correct permissions

     # mail setup
      MAIL_HOST: "smtp.example.com"
      MAIL_PORT: "587"
      MAIL_SECURE: "tls"
      MAIL_USER: "user@example.com"
      MAIL_PASS_FILE: "/run/secrets/mail_pass"

    secrets:
      - mail_pass

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health.php || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

secrets:
  mail_pass:
    file: ./secrets/mail_pass.txt
